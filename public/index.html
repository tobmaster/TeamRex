<!-- voter.html -->

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Voter</title>
    <style>
        body {
            font-family: sans-serif;
        }

        h1 {
            font-size: 1.5em;
            margin-bottom: 0.5em;
            text-align: center;
        }

        .fade {
            transition: opacity 0.5s ease-in;
            opacity: 1;
        }

        .out {
            opacity: 0;
        }

        #feedback {
            font-size: 10rem;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
        }
    </style>
</head>

<body>

    <h1>Welcome to Team-REX ðŸ¦–</h1>
    <div id="feedback" class="fade"></div>

    <script>
        const socket = new WebSocket(`ws://${document.location.host}/`);
        const feedback = document.getElementById('feedback');

        socket.onopen = () => {
            socket.send(JSON.stringify({ id: "sys", message: 'voter' }));
            console.log('Connected to server as voter');
        };

        socket.onmessage = (event) => {
            const input = JSON.parse(event.data);
            console.log('Received message:', input.message);
        };

        let history = [];

        function handleDeviceMotion(event) {
            console.log('motion', event);
            //const acceleration = event.accelerationIncludingGravity;
            const acceleration = event.acceleration;
            const accelerationZ = acceleration.z.toPrecision(1);

            const accelpercentage = (10 + parseFloat(accelerationZ)) / 20 * 100;
            const direction = (accelpercentage > 40 ? 'up' : (accelpercentage < 10 ? 'down' : '-'))
            history.unshift(direction);
            history = history.slice(0, 20);

            const upIndex = history.indexOf('up');
            const downIndex = history.indexOf('down');

            finalDirection = 'static';
            if (upIndex > -1 && downIndex > -1) {
                if (downIndex > upIndex) {
                    finalDirection = 'up';
                } else {
                    finalDirection = 'down';
                }
            }
            if (finalDirection === 'down') {
                return;
            }
            sendVote(finalDirection);
            feedback.toggleClass('out', false);
            feedback.innerHTML = finalDirection;
            setTimeout(() => {
                feedback.toggleClass('out', true);
            }, 0);
        }

        function sendVote(vote) {
            socket.send(JSON.stringify({ id: "vote", message: vote }));
            console.log('Sent vote:', vote);
        }

        window.addEventListener('devicemotion', handleDeviceMotion);
    </script>
</body>

</html>